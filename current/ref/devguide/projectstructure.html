<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Connectal Project Structure &mdash; connectal 14.12.6 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '14.12.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="connectal 14.12.6 documentation" href="../index.html" />
    <link rel="up" title="Connectal Developer’s Guide" href="devguide.html" />
    <link rel="next" title="Connectal BSV Libraries" href="../bsv/bsv.html" />
    <link rel="prev" title="Connectal Developer’s Guide" href="devguide.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../bsv-pkgindex.html" title="Bsv Package Index"
             >bsvpkgs</a> |</li>
        <li class="right" >
          <a href="../bsv/bsv.html" title="Connectal BSV Libraries"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="devguide.html" title="Connectal Developer’s Guide"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">connectal 14.12.6 documentation</a> &raquo;</li>
          <li><a href="devguide.html" accesskey="U">Connectal Developer&#8217;s Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="connectal-project-structure">
<h1>Connectal Project Structure<a class="headerlink" href="#connectal-project-structure" title="Permalink to this headline">¶</a></h1>
<p>The set of files composing the input to the Connectal toolchain is
referred to as a project.  A collection of out-of-tree example
projects is available at <a class="reference external" href="https://github.com/connectal-examples">https://github.com/connectal-examples</a>.
To illustrate the structure of a project, this chapter uses the
example <a class="reference external" href="https://github.com/connectal-examples/leds">https://github.com/connectal-examples/leds</a>, which can be
executed using the Bluesim or Zynq target platforms.</p>
<div class="section" id="project-makefile">
<h2>Project Makefile<a class="headerlink" href="#project-makefile" title="Permalink to this headline">¶</a></h2>
<p>The top-level Makefile
(<a class="reference external" href="https://github.com/connectal-examples/leds/blob/master/Makefile">https://github.com/connectal-examples/leds/blob/master/Makefile</a>)
defines parameters building and executing the project.  In its
simplest form, it specifies which Bluespec interfaces to use as
portals, the hardware and software source files, and the libraries to
use for the hardware and software compilation:</p>
<div class="highlight-python"><div class="highlight"><pre>INTERFACES = LedControllerRequest
BSVFILES = LedController.bsv Top.bsv
CPPFILES= testleds.cpp
NUMBER_OF_MASTERS =0
include \$(CONNECTALDIR)/Makefile.connectal
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">INTERFACES</span></tt> is a list of names of BSV interfaces which may be
used to communicate between the HW and SW componentsy.  In addition to
user-defined interfaces, there are a wide variety of interfaces
defined in Connectal libraries which may be included in this list.</p>
<p><tt class="docutils literal"><span class="pre">BSVFILES</span></tt> is a list of bsv files containing interface
definitions used to generate portals and module definitions used to
generate HW components.  Connectal bsv libraries can be used without
being listed explicitly.</p>
<p><tt class="docutils literal"><span class="pre">CPPFILES</span></tt> is a list of C/C++ files containing software
components and <tt class="docutils literal"><span class="pre">main</span></tt>.  The Connectal C/C++ libraries can be
used without being listed explicitly.</p>
<p><tt class="docutils literal"><span class="pre">NUMBER_OF_MASTERS</span></tt> is used to designate the number of host
bus masters the hardware components will instantiate.  For PCIe-based
platforms, this value can be set to 0 or 1, while on Zynq-based
platforms values from 0 to 4 are valid.</p>
<p><tt class="docutils literal"><span class="pre">CONNECTALDIR</span></tt> must be set so that the top-level Connectal
makefile can be included.  This brings in the default definitions of
all project build parameters as well as the Connectal hardware and
software libraries.  When running the toolchain on AWS, this varible
is set automatically in the build environment.
(hyperref[compiling_a_project]{Section~ref{compiling_a_project}})</p>
</div>
<div class="section" id="project-source">
<h2>Project Source<a class="headerlink" href="#project-source" title="Permalink to this headline">¶</a></h2>
<div class="section" id="interface-definitions">
<h3>Interface Definitions<a class="headerlink" href="#interface-definitions" title="Permalink to this headline">¶</a></h3>
<p>label{interface_definitions}</p>
<p>When generating portals, the Connectal interface compiler searches the
Connectal bsv libraries and the files listed in <tt class="docutils literal"><span class="pre">BSVFILES</span></tt> for
definitions of all the interfaces listed in <tt class="docutils literal"><span class="pre">INTERFACES</span></tt>.  If
an the definition of a listed interfaces is not found, an error is
reported the the compilation aborts.  The interfaces in this list must
be composed exclusively of <tt class="docutils literal"><span class="pre">Action</span></tt> methods.  Supported method
argument types are <tt class="docutils literal"><span class="pre">Bit\#(n)</span></tt>, <tt class="docutils literal"><span class="pre">Bool</span></tt>,
<tt class="docutils literal"><span class="pre">Int\#(32)</span></tt>, <tt class="docutils literal"><span class="pre">UInt\#(32)</span></tt>, <tt class="docutils literal"><span class="pre">Float</span></tt>,
<tt class="docutils literal"><span class="pre">Vector\#(t)</span></tt>, <tt class="docutils literal"><span class="pre">enum</span></tt>, and <tt class="docutils literal"><span class="pre">struct</span></tt>.</p>
</div>
<div class="section" id="software">
<h3>Software<a class="headerlink" href="#software" title="Permalink to this headline">¶</a></h3>
<p>The software in a Connectal project consists of at least one C++ file
which instantiates the generated portal wrappers and proxies and
implements <tt class="docutils literal"><span class="pre">main()</span></tt>.  The following source defines the SW
component of the example, which simply toggles LEDs on the Zedboard
(url{<a class="reference external" href="https://github.com/connectal-examples/leds/blob/master/testleds.cpp">https://github.com/connectal-examples/leds/blob/master/testleds.cpp</a>}):</p>
<div class="highlight-python"><div class="highlight"><pre>#include &lt;unistd.h&gt;
#include &quot;LedControllerRequest.h&quot;
#include &quot;GeneratedTypes.h&quot;
int main(int argc, const char **argv)
{
  LedControllerRequestProxy *device =
    new LedControllerRequestProxy(IfcNames_LedControllerRequest);
  for (int i = 0; i &lt; 20; i++) {
    device-&gt;setLeds(10, 10000);
    sleep(1);
    device-&gt;setLeds(5, 10000);
    sleep(1);
  }
}
</pre></div>
</div>
<p>The makefile listed <tt class="docutils literal"><span class="pre">LedControllerRequest</span></tt> as the only communication
interface.  The generated proxies and wrappers for this interface are
in <tt class="docutils literal"><span class="pre">LedControllerRequest.h</span></tt> which is included, along with C++
implementations of all additional interface types in
<tt class="docutils literal"><span class="pre">GeneratedTypes.h</span></tt>. Line 9 instantiates the proxy through which
the software invokes the hardware methods
(hyperref[flow_control]{Section~ref{flow_control}}).</p>
</div>
</div>
<div class="section" id="hardware">
<h2>Hardware<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h2>
<p>Connectal projects typically have at least one BSV file containing
interface declarations and module definitions.  The implementation of
the interfaces and all supporting infrastructure is standard BSV.
Interfaces being used as portals are subject to the type restrictions
described earlier
(hyperref[interface_definitions]{Section~ref{interface_definitions}}).</p>
<div class="section" id="top-bsv">
<h3>Top.bsv<a class="headerlink" href="#top-bsv" title="Permalink to this headline">¶</a></h3>
<p>In Top.bsv
(<a class="reference external" href="https://github.com/connectal-examples/leds/blob/master/Top.bsv">https://github.com/connectal-examples/leds/blob/master/Top.bsv</a>),
the developer instantiates all hardware modules explicitly.
Interfaces which can be invoked through portals need to be connected
to the generated wrappers and proxies.  To connect to the host
processor bus, a parameterized standard interface is used, making it
easy to synthesize the application for different CPUs or for
simulation:</p>
<div class="highlight-python"><div class="highlight"><pre>// Connectal Libraries
import CtrlMux::*;
import Portal::*;
import Leds::*;
import MemTypes::*;
import MemPortal::*;
import HostInterface::*;
import LedControllerRequest::*;
import LedController::*;

typedef enum {LedControllerRequestPortal} IfcNames deriving (Eq,Bits);

module mkConnectalTop(StdConnectalTop#(PhysAddrWidth));
   LedController ledController &lt;- mkLedControllerRequest();
   LedControllerRequestWrapper ledControllerRequestWrapper &lt;-
      mkLedControllerRequestWrapper(LedControllerRequestPortal,
      ledController.request);

   Vector#(1,StdPortal) portals;
   portals[0] = ledControllerRequestWrapper.portalIfc;
   let ctrl_mux &lt;- mkSlaveMux(portals);

   interface interrupt = getInterruptVector(portals);
   interface slave = ctrl_mux;
   interface masters = nil;
   interface leds = ledController.leds;
endmodule
</pre></div>
</div>
<p>Like the SW components, the HW begins by importing the generated
wrappers and proxies corresponding to the interfaces listed in the
project Makefile.  The user-defined implementation of the
LedControllerRequest interface is instantiated on line 14, and wrapped
on line 15.  This wrapped interface is connected to the bus using the
library module <tt class="docutils literal"><span class="pre">mkSlaveMux</span></tt> on line 21 so it can be invoked
from the software.  At the end of the module definition, the top-level
interface elements must be connected.  A board-specific top-level
module will include this file, instantiate <tt class="docutils literal"><span class="pre">mkConnectalTop</span></tt> and
connect the interfaces to the actual peripherals. The name of the file
must be <tt class="docutils literal"><span class="pre">Top.bsv</span></tt> and the name of the module must be
<tt class="docutils literal"><span class="pre">mkConnectalTop</span></tt>.</p>
<p>The Bluespec compiler generates a Verilog module from the top level
BSV module, in which the methods of exposed interfaces are implemented
as Verilog ports. Those ports are associated to physical pins on the
FPGA using a physical constraints file. If CPU specific interface
signals are needed by the design (for example, extra clocks that are
generated by the PCIe core), then an optional CPU-specific interface
can also be used.  If the design uses multiple clock domains or
additional pins on the FPGA, those connections are also made here by
exporting a &#8216;Pins&#8217; interface
(hyperref[host_interface]{Section~ref{host_interface}}).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Connectal Project Structure</a><ul>
<li><a class="reference internal" href="#project-makefile">Project Makefile</a></li>
<li><a class="reference internal" href="#project-source">Project Source</a><ul>
<li><a class="reference internal" href="#interface-definitions">Interface Definitions</a></li>
<li><a class="reference internal" href="#software">Software</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hardware">Hardware</a><ul>
<li><a class="reference internal" href="#top-bsv">Top.bsv</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="devguide.html"
                        title="previous chapter">Connectal Developer&#8217;s Guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../bsv/bsv.html"
                        title="next chapter">Connectal BSV Libraries</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/devguide/projectstructure.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../bsv-pkgindex.html" title="Bsv Package Index"
             >bsvpkgs</a> |</li>
        <li class="right" >
          <a href="../bsv/bsv.html" title="Connectal BSV Libraries"
             >next</a> |</li>
        <li class="right" >
          <a href="devguide.html" title="Connectal Developer’s Guide"
             >previous</a> |</li>
        <li><a href="../index.html">connectal 14.12.6 documentation</a> &raquo;</li>
          <li><a href="devguide.html" >Connectal Developer&#8217;s Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Jamey Hicks, Myron King, John Ankcorn.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>