
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Connectal Project Structure &#8212; connectal 20.05.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/tracking.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compiling and Running Connectal Project" href="compilingproject.html" />
    <link rel="prev" title="Connectal Rationale" href="design.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../bsv-pkgindex.html" title="Bsv Package Index"
             >bsvpkgs</a> |</li>
        <li class="right" >
          <a href="compilingproject.html" title="Compiling and Running Connectal Project"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="design.html" title="Connectal Rationale"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">connectal 20.05.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="devguide.html" accesskey="U">Connectal Developer’s Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="connectal-project-structure">
<h1>Connectal Project Structure<a class="headerlink" href="#connectal-project-structure" title="Permalink to this headline">¶</a></h1>
<p>The set of files composing the input to the Connectal toolchain is
referred to as a project.  A collection of out-of-tree example
projects is available at <a class="reference external" href="https://github.com/connectal-examples">https://github.com/connectal-examples</a>.
To illustrate the structure of a project, this chapter uses the
example <a class="reference external" href="https://github.com/connectal-examples/leds">https://github.com/connectal-examples/leds</a>, which can be
executed on the Bluesim or Zynq target platforms.</p>
<div class="section" id="project-makefile">
<h2>Project Makefile<a class="headerlink" href="#project-makefile" title="Permalink to this headline">¶</a></h2>
<p>The top-level Makefile in the project
(in our example, <a class="reference external" href="https://github.com/connectal-examples/leds/blob/master/Makefile">https://github.com/connectal-examples/leds/blob/master/Makefile</a>)
defines parameters building and executing the project.  In its
simplest form, it specifies the hardware and software source files,
which Bluespec interfaces to use as interfaces (portals) between them,
and the libraries to use for the hardware and software compilation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INTERFACES = LedControllerRequest
BSVFILES = LedController.bsv Top.bsv
CPPFILES= testleds.cpp
include \$(CONNECTALDIR)/Makefile.connectal
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BSVFILES</span></code> is a list of bsv files containing interface
definitions used to generate portals and module definitions used to
generate HW components.  Connectal bsv libraries can be used without
being listed explicitly.</p>
<p><code class="docutils literal notranslate"><span class="pre">CPPFILES</span></code> is a list of C/C++ files containing software
components and <code class="docutils literal notranslate"><span class="pre">main</span></code>.  The Connectal C/C++ libraries can be
used without being listed explicitly.</p>
<p><code class="docutils literal notranslate"><span class="pre">INTERFACES</span></code> is a list of names of BSV interfaces which may be
used to communicate between the HW and SW componentsy.  In addition to
user-defined interfaces, there are a wide variety of interfaces
defined in Connectal libraries which may be included in this list.</p>
<p><code class="docutils literal notranslate"><span class="pre">NUMBER_OF_MASTERS</span></code> is used to designate the number of host
bus masters the hardware components will instantiate.  For PCIe-based
platforms, this value can be set to 1, while on Zynq-based
platforms values from 1 to 4 are valid.</p>
<p><code class="docutils literal notranslate"><span class="pre">CONNECTALDIR</span></code> must be set so that the top-level Connectal
makefile can be included, defining the makefile build targets for the project.
This brings in the default definitions of
all project build parameters as well as the Connectal hardware and
software libraries.  When running the toolchain on AWS, this varible
is set automatically in the build environment.
(See <a class="reference internal" href="compilingproject.html#compiling-a-project"><span class="std std-ref">Compiling and Running Connectal Project</span></a>)</p>
</div>
<div class="section" id="project-source">
<h2>Project Source<a class="headerlink" href="#project-source" title="Permalink to this headline">¶</a></h2>
<div class="section" id="interface-definitions">
<h3>Interface Definitions<a class="headerlink" href="#interface-definitions" title="Permalink to this headline">¶</a></h3>
<p>label{interface_definitions}</p>
<p>When generating portals, the Connectal interface compiler searches the
Connectal bsv libraries and the files listed in <code class="docutils literal notranslate"><span class="pre">BSVFILES</span></code> for
definitions of the interfaces listed in <code class="docutils literal notranslate"><span class="pre">INTERFACES</span></code>.  If
the definition of a listed interfaces is not found, an error is
reported and the compilation aborts.  The interfaces in this list must
be composed exclusively of <code class="docutils literal notranslate"><span class="pre">Action</span></code> methods.  Supported method
argument types are <code class="docutils literal notranslate"><span class="pre">Bit\#(n)</span></code>, <code class="docutils literal notranslate"><span class="pre">Bool</span></code>,
<code class="docutils literal notranslate"><span class="pre">Int\#(32)</span></code>, <code class="docutils literal notranslate"><span class="pre">UInt\#(32)</span></code>, <code class="docutils literal notranslate"><span class="pre">Float</span></code>,
<code class="docutils literal notranslate"><span class="pre">Vector\#(t)</span></code>, <code class="docutils literal notranslate"><span class="pre">enum</span></code>, and <code class="docutils literal notranslate"><span class="pre">struct</span></code>.</p>
</div>
<div class="section" id="software">
<h3>Software<a class="headerlink" href="#software" title="Permalink to this headline">¶</a></h3>
<p>The software in a Connectal project consists of at least one C++ file
which instantiates the generated portal wrappers and proxies and
implements <code class="docutils literal notranslate"><span class="pre">main()</span></code>.  The following source defines the SW
component of the example, which simply toggles LEDs on the Zedboard
(url{<a class="reference external" href="https://github.com/connectal-examples/leds/blob/master/testleds.cpp">https://github.com/connectal-examples/leds/blob/master/testleds.cpp</a>}):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;unistd.h&gt;</span>
<span class="c1">#include &quot;LedControllerRequest.h&quot;</span>
<span class="c1">#include &quot;GeneratedTypes.h&quot;</span>
<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedControllerRequestProxy</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span>
    <span class="n">new</span> <span class="n">LedControllerRequestProxy</span><span class="p">(</span><span class="n">IfcNames_LedControllerRequest</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">device</span><span class="o">-&gt;</span><span class="n">setLeds</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">device</span><span class="o">-&gt;</span><span class="n">setLeds</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The makefile listed <code class="docutils literal notranslate"><span class="pre">LedControllerRequest</span></code> as the only communication
interface.  The generated proxies and wrappers for this interface are
in <code class="docutils literal notranslate"><span class="pre">LedControllerRequest.h</span></code> which is included, along with C++
implementations of all additional interface types in
<code class="docutils literal notranslate"><span class="pre">GeneratedTypes.h</span></code>. Line 9 instantiates the proxy through which
the software invokes the hardware methods
(See also <a class="reference internal" href="../design/flowcontrol.html#flow-control"><span class="std std-ref">Flow Control</span></a>)</p>
<p>To support projects that will execute software inside the linux kernel
(for example, to work in conjunction with filesystems or the network stack),
connectal project software can also be written in C.</p>
</div>
</div>
<div class="section" id="hardware">
<h2>Hardware<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h2>
<p>Connectal projects typically have at least one BSV file containing
interface declarations and module definitions.  The implementation of
the interfaces and all supporting infrastructure is standard BSV.
Interfaces being used as portals are subject to the type restrictions
described earlier
(See also <a class="reference internal" href="../design/interface_definitions.html#interface-definitions"><span class="std std-ref">Interface Declarations</span></a>)</p>
<div class="section" id="top-bsv">
<h3>Top.bsv<a class="headerlink" href="#top-bsv" title="Permalink to this headline">¶</a></h3>
<p>In Top.bsv
(<a class="reference external" href="https://github.com/connectal-examples/leds/blob/master/Top.bsv">https://github.com/connectal-examples/leds/blob/master/Top.bsv</a>),
the developer instantiates all hardware modules explicitly.
Interfaces which can be invoked through portals need to be connected
to the generated wrappers and proxies.  To connect to the host
processor bus, a parameterized standard interface is used, making it
easy to synthesize the application for different CPUs or for
simulation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Connectal</span> <span class="n">Libraries</span>
<span class="kn">import</span> <span class="nn">CtrlMux</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">Portal</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">Leds</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">MemTypes</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">MemPortal</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">HostInterface</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">LedControllerRequest</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">LedController</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="n">typedef</span> <span class="n">enum</span> <span class="p">{</span><span class="n">LedControllerRequestPortal</span><span class="p">}</span> <span class="n">IfcNames</span> <span class="n">deriving</span> <span class="p">(</span><span class="n">Eq</span><span class="p">,</span><span class="n">Bits</span><span class="p">);</span>

<span class="n">module</span> <span class="n">mkConnectalTop</span><span class="p">(</span><span class="n">StdConnectalTop</span><span class="c1">#(PhysAddrWidth));</span>
   <span class="n">LedController</span> <span class="n">ledController</span> <span class="o">&lt;-</span> <span class="n">mkLedControllerRequest</span><span class="p">();</span>
   <span class="n">LedControllerRequestWrapper</span> <span class="n">ledControllerRequestWrapper</span> <span class="o">&lt;-</span>
      <span class="n">mkLedControllerRequestWrapper</span><span class="p">(</span><span class="n">LedControllerRequestPortal</span><span class="p">,</span>
      <span class="n">ledController</span><span class="o">.</span><span class="n">request</span><span class="p">);</span>

   <span class="n">Vector</span><span class="c1">#(1,StdPortal) portals;</span>
   <span class="n">portals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ledControllerRequestWrapper</span><span class="o">.</span><span class="n">portalIfc</span><span class="p">;</span>
   <span class="n">let</span> <span class="n">ctrl_mux</span> <span class="o">&lt;-</span> <span class="n">mkSlaveMux</span><span class="p">(</span><span class="n">portals</span><span class="p">);</span>

   <span class="n">interface</span> <span class="n">interrupt</span> <span class="o">=</span> <span class="n">getInterruptVector</span><span class="p">(</span><span class="n">portals</span><span class="p">);</span>
   <span class="n">interface</span> <span class="n">slave</span> <span class="o">=</span> <span class="n">ctrl_mux</span><span class="p">;</span>
   <span class="n">interface</span> <span class="n">masters</span> <span class="o">=</span> <span class="n">nil</span><span class="p">;</span>
   <span class="n">interface</span> <span class="n">leds</span> <span class="o">=</span> <span class="n">ledController</span><span class="o">.</span><span class="n">leds</span><span class="p">;</span>
<span class="n">endmodule</span>
</pre></div>
</div>
<p>Like the SW components, the HW begins by importing the generated
wrappers and proxies corresponding to the interfaces listed in the
project Makefile.  The user-defined implementation of the
LedControllerRequest interface is instantiated on line 14, and wrapped
on line 15.  This wrapped interface is connected to the bus using the
library module <code class="docutils literal notranslate"><span class="pre">mkSlaveMux</span></code> on line 21 so it can be invoked
from the software.  At the end of the module definition, the top-level
interface elements must be connected.  A board-specific top-level
module will include this file, instantiate <code class="docutils literal notranslate"><span class="pre">mkConnectalTop</span></code> and
connect the interfaces to the actual peripherals. The module
<code class="docutils literal notranslate"><span class="pre">mkConnectalTop</span></code> must be defined in a file named
<code class="docutils literal notranslate"><span class="pre">Top.bsv</span></code> in the user project.</p>
<p>The Bluespec compiler generates a Verilog module from the top level
BSV module, in which the methods of exposed interfaces are implemented
as Verilog ports. Those ports are bound to physical pins on the
FPGA using a physical constraints file. If CPU specific interface
signals are needed by the design (for example, extra clocks that are
generated by the PCIe core), then an optional CPU-specific HostInterface
parameter to <code class="docutils literal notranslate"><span class="pre">mkConnectalTop</span></code> can also be used.  If the design uses
external pins on the FPGA, those connections are also made here by
exporting a ‘Pins’ interface
(hyperref[host_interface]{Section~ref{host_interface}})
and providing bindings in the constraints file.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Connectal Project Structure</a><ul>
<li><a class="reference internal" href="#project-makefile">Project Makefile</a></li>
<li><a class="reference internal" href="#project-source">Project Source</a><ul>
<li><a class="reference internal" href="#interface-definitions">Interface Definitions</a></li>
<li><a class="reference internal" href="#software">Software</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hardware">Hardware</a><ul>
<li><a class="reference internal" href="#top-bsv">Top.bsv</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="design.html"
                        title="previous chapter">Connectal Rationale</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="compilingproject.html"
                        title="next chapter">Compiling and Running Connectal Project</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/devguide/projectstructure.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../bsv-pkgindex.html" title="Bsv Package Index"
             >bsvpkgs</a> |</li>
        <li class="right" >
          <a href="compilingproject.html" title="Compiling and Running Connectal Project"
             >next</a> |</li>
        <li class="right" >
          <a href="design.html" title="Connectal Rationale"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">connectal 20.05.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="devguide.html" >Connectal Developer’s Guide</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015-2020, Jamey Hicks, Myron King, John Ankcorn.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>